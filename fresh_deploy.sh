#!/bin/bash

# ๐ ะกะบัะธะฟั ะฟะพะปะฝะพะน ะฟะตัะตัััะฐะฝะพะฒะบะธ TrendPulse AI
# ะะฒัะพั: TrendPulse AI Team
# ะะฐัะฐ: $(date)

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐะตะผ ะฟะพะปะฝัั ะฟะตัะตัััะฐะฝะพะฒะบั TrendPulse AI..."

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธั ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ะะจะะะะ]${NC} $1"
}

success() {
    echo -e "${GREEN}[ะฃะกะะะฅ]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[ะะะะะฃะะะะะะะะะ]${NC} $1"
}

# ะัะพะฒะตัะบะฐ, ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f ".env" ]; then
    error "ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ. ะฃะฑะตะดะธัะตัั, ััะพ ะฒั ะฝะฐัะพะดะธัะตัั ะฒ ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ."
    exit 1
fi

log "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# 1. ะกะพััะฐะฝัะตะผ .env ัะฐะนะป
log "๐พ ะกะพััะฐะฝัะตะผ .env ัะฐะนะป..."
cp .env /tmp/trendpulse.env.backup
success ".env ัะฐะนะป ัะพััะฐะฝะตะฝ ะฒ /tmp/trendpulse.env.backup"

# 2. ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั
log "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
if [ -f "docker-compose.yml" ]; then
    docker-compose down || true
    success "ะะพะฝัะตะนะฝะตัั ะพััะฐะฝะพะฒะปะตะฝั"
else
    warning "docker-compose.yml ะฝะต ะฝะฐะนะดะตะฝ, ะฟัะพะฟััะบะฐะตะผ ะพััะฐะฝะพะฒะบั ะบะพะฝัะตะนะฝะตัะพะฒ"
fi

# 3. ะัะธัะฐะตะผ Docker
log "๐งน ะัะธัะฐะตะผ Docker..."
docker container prune -f || true
docker image prune -a -f || true
docker volume prune -f || true
docker network prune -f || true
docker system prune -a -f || true
success "Docker ะพัะธัะตะฝ"

# 4. ะฃะดะฐะปัะตะผ ััะฐััะต ัะฐะนะปั
log "๐๏ธ ะฃะดะฐะปัะตะผ ััะฐััะต ัะฐะนะปั ะฟัะพะตะบัะฐ..."
cd /opt
rm -rf trendpulse-ai
mkdir trendpulse-ai
cd trendpulse-ai
success "ะกัะฐััะต ัะฐะนะปั ัะดะฐะปะตะฝั, ะฝะพะฒะฐั ะดะธัะตะบัะพัะธั ัะพะทะดะฐะฝะฐ"

# 5. ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ .env
log "๐ ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ .env ัะฐะนะป..."
cp /tmp/trendpulse.env.backup .env
success ".env ัะฐะนะป ะฒะพัััะฐะฝะพะฒะปะตะฝ"

# 6. ะกะบะฐัะธะฒะฐะตะผ ัะฒะตะถะธะน ะบะพะด
log "๐ฅ ะกะบะฐัะธะฒะฐะตะผ ัะฒะตะถะธะน ะบะพะด ะธะท ัะตะฟะพะทะธัะพัะธั..."
git clone https://github.com/Rozareoagro14/trendpulse-ai.git .
success "ะะพะด ัะบะฐัะฐะฝ ะธะท ัะตะฟะพะทะธัะพัะธั"

# 7. ะัะพะฒะตััะตะผ ััััะบัััั
log "๐ ะัะพะฒะตััะตะผ ััััะบัััั ะฟัะพะตะบัะฐ..."
if [ ! -f "docker-compose.yml" ]; then
    error "docker-compose.yml ะฝะต ะฝะฐะนะดะตะฝ ะฟะพัะปะต ะบะปะพะฝะธัะพะฒะฐะฝะธั"
    exit 1
fi

if [ ! -f "backend/main.py" ]; then
    error "backend/main.py ะฝะต ะฝะฐะนะดะตะฝ ะฟะพัะปะต ะบะปะพะฝะธัะพะฒะฐะฝะธั"
    exit 1
fi

if [ ! -f "bot/main.py" ]; then
    error "bot/main.py ะฝะต ะฝะฐะนะดะตะฝ ะฟะพัะปะต ะบะปะพะฝะธัะพะฒะฐะฝะธั"
    exit 1
fi

success "ะกัััะบัััะฐ ะฟัะพะตะบัะฐ ะบะพััะตะบัะฝะฐ"

# 8. ะกะพะฑะธัะฐะตะผ ะพะฑัะฐะทั
log "๐จ ะกะพะฑะธัะฐะตะผ Docker ะพะฑัะฐะทั..."
docker-compose build --no-cache
success "ะะฑัะฐะทั ัะพะฑัะฐะฝั"

# 9. ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั
log "๐ ะะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker-compose up -d
success "ะะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั"

# 10. ะะดะตะผ ะทะฐะฟััะบะฐ
log "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ..."
sleep 10

# 11. ะัะพะฒะตััะตะผ ััะฐััั
log "๐ ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose ps

# 12. ะัะพะฒะตััะตะผ API
log "๐ ะัะพะฒะตััะตะผ API..."
for i in {1..30}; do
    if curl -s "http://localhost:8000/health" > /dev/null; then
        success "API ะพัะฒะตัะฐะตั ะฝะฐ ะฟะพััั 8000"
        break
    fi
    if [ $i -eq 30 ]; then
        error "API ะฝะต ะพัะฒะตัะฐะตั ะฟะพัะปะต 30 ะฟะพะฟััะพะบ"
        log "ะัะพะฒะตััะตะผ ะปะพะณะธ..."
        docker-compose logs backend | tail -20
        exit 1
    fi
    sleep 2
done

# 13. ะัะพะฒะตััะตะผ ะปะพะณะธ
log "๐ ะัะพะฒะตััะตะผ ะปะพะณะธ..."
echo "=== ะะพะณะธ Backend ==="
docker-compose logs backend | tail -5
echo ""
echo "=== ะะพะณะธ Bot ==="
docker-compose logs bot | tail -5

# 14. ะะพะฑะฐะฒะปัะตะผ ะฟะพะดััะดัะธะบะพะฒ (ะตัะปะธ ัะบัะธะฟั ะตััั)
if [ -f "add_contractors.py" ]; then
    log "๐ท ะะพะฑะฐะฒะปัะตะผ ะฟะพะดััะดัะธะบะพะฒ..."
    if command -v python3 &> /dev/null; then
        if command -v pip3 &> /dev/null; then
            pip3 install httpx || true
            python3 add_contractors.py || warning "ะะต ัะดะฐะปะพัั ะดะพะฑะฐะฒะธัั ะฟะพะดััะดัะธะบะพะฒ"
        else
            warning "pip3 ะฝะต ัััะฐะฝะพะฒะปะตะฝ, ะฟัะพะฟััะบะฐะตะผ ะดะพะฑะฐะฒะปะตะฝะธะต ะฟะพะดััะดัะธะบะพะฒ"
        fi
    else
        warning "python3 ะฝะต ัััะฐะฝะพะฒะปะตะฝ, ะฟัะพะฟััะบะฐะตะผ ะดะพะฑะฐะฒะปะตะฝะธะต ะฟะพะดััะดัะธะบะพะฒ"
    fi
fi

# 15. ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
log "โ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ..."
echo ""
echo "=== ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ ==="
docker-compose ps
echo ""
echo "=== ะัะพะฒะตัะบะฐ API ==="
curl -s "http://localhost:8000/health" | jq . 2>/dev/null || curl -s "http://localhost:8000/health"
echo ""
echo "=== ะัะพะฒะตัะบะฐ ะฟัะพะตะบัะพะฒ ==="
curl -s "http://localhost:8000/projects/" | jq '. | length' 2>/dev/null || echo "ะะต ัะดะฐะปะพัั ะฟัะพะฒะตัะธัั ะฟัะพะตะบัั"
echo ""
echo "=== ะัะพะฒะตัะบะฐ ะฟะพะดััะดัะธะบะพะฒ ==="
curl -s "http://localhost:8000/contractors/" | jq '. | length' 2>/dev/null || echo "ะะต ัะดะฐะปะพัั ะฟัะพะฒะตัะธัั ะฟะพะดััะดัะธะบะพะฒ"

success "๐ ะะตัะตัััะฐะฝะพะฒะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ!"
echo ""
echo "๐ฑ ะขะตะฟะตัั ะผะพะถะตัะต ะฟัะพะฒะตัะธัั ะฑะพัะฐ ะฒ Telegram:"
echo "   1. ะัะบัะพะนัะต ะฑะพัะฐ"
echo "   2. ะะฐะถะผะธัะต '๐ ะะพะธ ะฟัะพะตะบัั'"
echo "   3. ะะฐะถะผะธัะต '๐ท ะะพะดััะดัะธะบะธ'"
echo "   4. ะะฐะถะผะธัะต '๐ ะกัะตะฝะฐัะธะธ'"
echo ""
echo "๐ง ะัะปะธ ััะพ-ัะพ ะฝะต ัะฐะฑะพัะฐะตั, ะฟัะพะฒะตัััะต ะปะพะณะธ:"
echo "   docker-compose logs -f" 