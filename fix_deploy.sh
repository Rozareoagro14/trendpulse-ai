#!/bin/bash

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –¥–µ–ø–ª–æ–µ–º –∏ –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker compose down

# –†–µ—à–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å Git
echo "üì• –†–µ—à–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å Git..."
git stash
git pull origin main
git stash pop

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã
echo "üî® –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã..."
docker compose build --no-cache

# –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å —Ç–µ—Å—Ç–∞–º–∏
echo "‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ç–µ—Å—Ç–∞–º–∏..."
docker compose up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∏ —Ç–µ—Å—Ç–æ–≤
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤..."
sleep 45

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose ps

# –ü—Ä–æ–≤–µ—Ä—è–µ–º API
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º API..."
sleep 10
if curl -f http://localhost:8000/health > /dev/null 2>&1; then
    echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ backend..."
    docker compose logs backend --tail=20
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ—Ç–∞
echo "ü§ñ –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ—Ç–∞..."
if docker compose ps | grep -q "bot.*running"; then
    echo "‚úÖ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå –ë–æ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
    echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –±–æ—Ç–∞..."
    docker compose logs bot --tail=10
fi

# –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã
echo "üß™ –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã..."
if [ -f "test_api.sh" ]; then
    chmod +x test_api.sh
    ./test_api.sh
else
    echo "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç test_api.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏
echo "üìà –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤..."
if [ -f "generate_all_scenarios.py" ]; then
    python3 generate_all_scenarios.py
else
    echo "‚ö†Ô∏è –°–∫—Ä–∏–ø—Ç generate_all_scenarios.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "üéØ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
echo "üì± –ë–æ—Ç: @TrendPulseAI_bot"
echo "üåê API: http://localhost:8000"
echo "üìä –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: http://localhost:8000/docs"
echo "üß™ –¢–µ—Å—Ç—ã: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ"

echo "üéâ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "‚ú® –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:"
echo "  ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"
echo "  ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤"
echo "  ‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤"
echo "  ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ PDF –æ—Ç—á–µ—Ç—ã"
echo "  ‚úÖ –ë—ã—Å—Ç—Ä—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å volumes"
echo "  ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω async –¥—Ä–∞–π–≤–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
echo ""
echo "üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!" 